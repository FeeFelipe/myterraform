# ğŸš€ Terraform + LocalStack + Nomad + Custom Provider (localmeta)

This project demonstrates a **local development environment** for AWS using **LocalStack**, **Nomad**, and **Terraform** with a **custom Terraform provider** that generates local JSON metadata.

---

## ğŸ“¦ Project Structure

```
.
â”œâ”€ docker-compose.yml                # Local environment orchestration
â”œâ”€ Dockerfile.terraform               # Multi-stage build for Terraform + provider
â”œâ”€ jobs/                              # Nomad jobs (example)
â”œâ”€ init/                              # LocalStack init scripts
â”œâ”€ localstack-data/                   # LocalStack persistent data
â”œâ”€ aws/                               # AWS CLI config for LocalStack
â”œâ”€ terraform-localstack/              # Terraform project
â”‚  â”œâ”€ main.tf
â”‚  â”œâ”€ providers.tf
â”‚  â”œâ”€ variables.tf
â”‚  â”œâ”€ outputs.tf
â”‚  â”œâ”€ dev.tfvars
â”‚  â””â”€ modules/
â”‚      â”œâ”€ s3/
â”‚      â”œâ”€ sqs/
â”‚      â””â”€ iam-user/
â””â”€ terraform-provider-localmeta/      # Custom Terraform provider (Go)
   â”œâ”€ main.go
   â”œâ”€ provider.go
   â”œâ”€ resource_bucketmeta.go
   â””â”€ go.mod
```

---

## âš™ï¸ Components

- **Nomad**: Orchestrator for local jobs (optional in this demo)
- **LocalStack**: Simulates AWS services (S3, SQS, DynamoDB)
- **AWS CLI**: Interact with LocalStack endpoints
- **Terraform**: Provision resources locally
- **Local Provider (`localmeta`)**: Generates JSON metadata for S3 buckets

---

## ğŸš€ Getting Started

### 1ï¸âƒ£ Build and start environment

```bash
docker compose up -d --build
```

This will:

1. Compile the custom Terraform provider.
2. Start:
   - Nomad
   - LocalStack
   - AWS CLI container
   - Terraform container

---

### 2ï¸âƒ£ Access the Terraform container

```bash
docker exec -it terraform sh
```

---

### 3ï¸âƒ£ Initialize Terraform

Inside the container:

```bash
terraform init
terraform plan -var-file=dev.tfvars
terraform apply -auto-approve -var-file=dev.tfvars
```

---

### 4ï¸âƒ£ Verify Resources

- **LocalStack** Web UI: [http://localhost:4566](http://localhost:4566)
- **List S3 buckets**:

```bash
aws --endpoint-url=http://localstack:4566 s3 ls
```

- **Check generated metadata file** (from custom provider):

```bash
/workspace/<bucket_name>.json
```

Example:

```json
{
  "bucket_name": "my-dev-bucket",
  "tags": {
    "Environment": "local",
    "Project": "demo"
  }
}
```

---

## ğŸ›  Custom Terraform Provider

- Path: `terraform-provider-localmeta/`
- Module name: `local/localmeta`
- Example usage in Terraform:

```hcl
provider "localmeta" {}

resource "localmeta_bucket" "metadata" {
  bucket_name = module.s3.bucket_name
  tags        = var.default_tags
}
```

When applied, this creates a `<bucket_name>.json` file with the tags and bucket name.

---

## ğŸ§¹ Clean up

```bash
terraform destroy -auto-approve -var-file=dev.tfvars
docker compose down -v
```

---

## ğŸ“– Notes

- Compatible with **Terraform 1.9.x**
- Custom provider automatically compiled in Docker build
- All AWS calls point to **LocalStack** (no real AWS charges)

---

**Author:** Felipe Cavalieri
**License:** MIT
